<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AgendaEstética - SaaS de Agenda Online para Profissionais Estéticos">
    <meta name="theme-color" content="#6B46C1">
    
    <title>AgendaEstética - Login</title>
    
    <link rel="stylesheet" href="styles/global.css">
    <link rel="stylesheet" href="styles/login.css">
    
    <!-- Security: Firebase Configuration loaded from environment variables -->
    <!-- Supports: window.APP_CONFIG.firebase (priority) OR import.meta.env (Vite) -->
    <!-- In production (Vercel): Set environment variables in Vercel Dashboard -->
    <!-- In local development: Copy .env.example to .env and fill values -->
    
    <script>
    // SECURITY: Load Firebase config from environment variables
    // Priority: 1) window.APP_CONFIG.firebase  2) import.meta.env (Vite/build tools)
    
    (function() {
        // Check for Vite/build tool environment variables
        const envConfig = {
            apiKey: typeof importMetaEnv !== 'undefined' ? importMetaEnv.VITE_FIREBASE_API_KEY : null,
            authDomain: typeof importMetaEnv !== 'undefined' ? importMetaEnv.VITE_FIREBASE_AUTH_DOMAIN : null,
            projectId: typeof importMetaEnv !== 'undefined' ? importMetaEnv.VITE_FIREBASE_PROJECT_ID : null,
            storageBucket: typeof importMetaEnv !== 'undefined' ? importMetaEnv.VITE_FIREBASE_STORAGE_BUCKET : null,
            messagingSenderId: typeof importMetaEnv !== 'undefined' ? importMetaEnv.VITE_FIREBASE_MESSAGING_SENDER_ID : null,
            appId: typeof importMetaEnv !== 'undefined' ? importMetaEnv.VITE_FIREBASE_APP_ID : null,
        };
        
        // Use env vars if available, otherwise keep undefined for config.js validation
        if (envConfig.apiKey) {
            window.APP_CONFIG = { firebase: envConfig };
        }
        
        // Log configuration status (only in development)
        const isDev = typeof importMetaEnv !== 'undefined' ? 
            importMetaEnv.VITE_PRODUCTION_ENV !== 'true' : true;
        
        if (isDev && !window.APP_CONFIG?.firebase?.apiKey) {
            console.warn('⚠️ Firebase configuration incomplete.');
            console.warn('Please set environment variables or window.APP_CONFIG.firebase');
            console.warn('See .env.example for reference.');
        }
    })();
    </script>
</head>
<body>
    <div id="app">
        <!-- Loading state while Firebase initializes -->
        <div class="loading-screen" id="loading-screen">
            <div class="loading-spinner"></div>
            <p>Carregando AgendaEstética...</p>
        </div>
    </div>
    
    <script type="module">
        import firebaseConfig from './config.js';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js';
        import { getAuth, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js';
        import { setupRouter } from './router.js';
        import { verificarSessao } from './modules/auth.js';
        
        // Security: Validate Firebase configuration before initialization
        const requiredFields = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
        const missingFields = requiredFields.filter(field => !firebaseConfig[field]);
        
        if (missingFields.length > 0) {
            console.error('❌ Firebase Configuration Error: Missing fields:', missingFields.join(', '));
            document.getElementById('loading-screen').innerHTML = `
                <div class="error-screen">
                    <h2>Erro de Configuração</h2>
                    <p>Faltam configurações do Firebase necessárias.</p>
                    <p class="error-details">Campos ausentes: ${missingFields.join(', ')}</p>
                    <p>Configure as variáveis de ambiente ou Defina window.APP_CONFIG.firebase</p>
                    <small>Veja .env.example para referência</small>
                </div>
            `;
            throw new Error('Firebase configuration incomplete');
        }
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Enable persistence for offline support
        setPersistence(auth, browserLocalPersistence)
            .catch(error => console.warn('Persistence error:', error.message));
        
        // Make Firebase services globally available
        window.firebase = {
            app,
            auth,
            db,
            storage,
            firestore: window.firebaseFirestore || db, // Fallback
        };
        
        // Setup router and check session on load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await setupRouter();
                await verificarSessao();
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('loading-screen').innerHTML = `
                    <div class="error-screen">
                        <h2>Erro ao Inicializar</h2>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });
    </script>
    
    <style>
        /* Loading Screen Styles */
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-border, #e0e0e0);
            border-top-color: var(--color-primary, #6B46C1);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-screen {
            text-align: center;
            padding: 24px;
            max-width: 400px;
        }
        
        .error-screen h2 {
            color: var(--color-error, #f44336);
            margin-bottom: 16px;
        }
        
        .error-details {
            font-size: 12px;
            color: var(--color-text-secondary, #666);
            margin-top: 8px;
        }
    </style>
</body>
</html>
