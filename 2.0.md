# Corre√ß√£o do Cadastro de Cliente ‚Äì Backend / Firebase Auth

## üìå Contexto do Projeto

O projeto **Agenda Est√©tica** utiliza:

- Firebase Authentication (Email/Password)
- Firestore como banco de dados
- Frontend em JavaScript (SPA)
- Deploy via Vercel

Atualmente existe um **problema cr√≠tico no cadastro de clientes pela tela de login**, onde a chamada ao endpoint do Firebase:

POST https://identitytoolkit.googleapis.com/v1/accounts:signUp


retorna **400 Bad Request**, impedindo o fluxo normal de cria√ß√£o de conta.

Al√©m disso:
- As mensagens de erro n√£o s√£o claras para o usu√°rio
- O sistema tenta cadastrar usu√°rios inv√°lidos
- H√° risco de m√∫ltiplas inicializa√ß√µes do Firebase
- N√£o existe valida√ß√£o preventiva no backend l√≥gico

---

## üéØ Objetivo

Corrigir e fortalecer completamente o fluxo de **cadastro de cliente**, garantindo que:

- O signup funcione corretamente
- Erros sejam tratados e exibidos de forma clara
- Firebase seja inicializado corretamente
- N√£o existam tentativas desnecess√°rias de cadastro
- O Firestore permane√ßa consistente

Este documento define **o que deve ser implementado**, **como** e **com quais crit√©rios de aceita√ß√£o**.

---

## üîç An√°lise do Erro Atual

O erro `400 Bad Request` no `accounts:signUp` pode ocorrer por:

- `auth/email-already-in-use`
- `auth/weak-password` (menos de 6 caracteres)
- `auth/invalid-email`
- Provider Email/Password desabilitado no Firebase Console
- API Key com restri√ß√µes
- Dados inv√°lidos sendo enviados (null/undefined)

Atualmente, esses erros:
- N√£o s√£o capturados corretamente
- N√£o s√£o traduzidos para o usu√°rio
- Quebram o fluxo sem explica√ß√£o

---

## üß© Escopo das Corre√ß√µes

### 1Ô∏è‚É£ Tratamento correto de erros do Firebase Auth

No arquivo `auth.js` (ou equivalente):

- Capturar explicitamente os erros do Firebase Auth
- Mapear os erros para mensagens leg√≠veis

#### Erros obrigat√≥rios a tratar:
| C√≥digo Firebase | Mensagem ao usu√°rio |
|----------------|--------------------|
| auth/email-already-in-use | Este email j√° est√° cadastrado |
| auth/weak-password | A senha deve conter no m√≠nimo 6 caracteres |
| auth/invalid-email | Email inv√°lido |
| auth/operation-not-allowed | Cadastro por email est√° desativado |
| default | Erro ao criar conta. Tente novamente |

‚ö†Ô∏è Nunca exibir mensagens t√©cnicas ou objetos de erro brutos no frontend.

---

### 2Ô∏è‚É£ Valida√ß√£o preventiva antes do signup

Antes de chamar `createUserWithEmailAndPassword`:

- Validar localmente:
  - Email n√£o vazio
  - Email com formato v√°lido
  - Senha com no m√≠nimo 6 caracteres
- Consultar o Firestore:
  - Verificar se j√° existe um cliente com o mesmo email

Se o email j√° existir:
- Bloquear o fluxo
- Exibir mensagem clara
- N√ÉO chamar Firebase Auth

Objetivo: evitar erros 400 desnecess√°rios.

---

### 3Ô∏è‚É£ Inicializa√ß√£o correta do Firebase

Garantir que:

- Firebase seja inicializado **uma √∫nica vez**
- N√£o existam m√∫ltiplos `initializeApp()`
- `auth.js`, `login.js` e outros m√≥dulos reutilizem a mesma inst√¢ncia

Caso o Firebase n√£o esteja inicializado:
- Falhar imediatamente
- Logar erro claro no console
- N√£o tentar autentica√ß√£o

---

### 4Ô∏è‚É£ Estrutura consistente de dados no Firestore

Ap√≥s o signup bem-sucedido:

- Criar documento do cliente no Firestore
- Estrutura recomendada:

clientes/{uid}
{
nome: string,
email: string,
telefone: string,
role: "cliente",
createdAt: timestamp
}


Regras:
- UID do Auth deve ser o ID do documento
- Campos obrigat√≥rios n√£o podem ser nulos
- Se a escrita no Firestore falhar:
  - Logar erro
  - Evitar deixar usu√°rio ‚Äú√≥rf√£o‚Äù sem dados

---

### 5Ô∏è‚É£ Logging e Debug controlado

Adicionar logs claros para facilitar manuten√ß√£o:

Exemplos:
- üîß Iniciando cadastro de cliente
- ‚ùå Valida√ß√£o local falhou
- ‚ùå Email j√° existe no Firestore
- ‚úÖ Firebase Auth criado com sucesso
- ‚úÖ Cliente salvo no Firestore

Logs devem:
- Ajudar o desenvolvedor
- N√£o expor dados sens√≠veis

---

## üö´ Fora de Escopo

Este documento **N√ÉO autoriza**:

- Altera√ß√µes visuais (UI/UX)
- Mudan√ßa de layout
- Renomear telas ou menus
- Implementar novas features
- Criar link p√∫blico do profissional (futuro)

Foco exclusivo: **backend l√≥gico do cadastro de cliente**.

---

## ‚úÖ Crit√©rios de Aceita√ß√£o

O problema ser√° considerado resolvido quando:

- Cadastro de cliente funcionar em condi√ß√µes v√°lidas
- Emails duplicados n√£o causarem erro 400
- Senhas fracas sejam barradas antes do Firebase
- Firebase seja inicializado corretamente
- Mensagens exibidas ao usu√°rio sejam claras
- Nenhum erro 400 ocorra silenciosamente
- Firestore permane√ßa consistente

---

## üß† Observa√ß√µes T√©cnicas

- Firebase Auth **n√£o substitui valida√ß√£o de neg√≥cio**
- Firestore deve ser usado como camada de controle
- UX melhora quando erros s√£o prevenidos, n√£o tratados depois
- Esse ajuste √© base para futuras features (ex: link p√∫blico)

---

## üß© Pr√≥ximos Passos (Ap√≥s Corre√ß√£o)

1. Revisar regras de seguran√ßa do Firestore
2. Implementar link p√∫blico do profissional
3. Ajustar pap√©is (cliente x profissional)
4. Melhorar UX com mensagens de sucesso

---

**Documento criado para orientar corre√ß√µes backend do projeto Agenda Est√©tica.**
