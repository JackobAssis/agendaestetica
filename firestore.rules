rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Empresas (tenants)
    match /empresas/{empresaId} {
      allow read: if true;

      // Create empresa only by authenticated user who sets themselves as proprietarioUid
      allow create: if request.auth != null && request.resource.data.proprietarioUid == request.auth.uid;

      // Only proprietario can update/delete empresa
      allow update, delete: if request.auth != null && resource.data.proprietarioUid == request.auth.uid;

      // Notificações: allow public create (used by booking flow), reads restricted to owner
      match /notificacoes/{notifId} {
        allow create: if true;
        allow read: if request.auth != null && get(/databases/$(database)/documents/empresas/$(empresaId)).data.proprietarioUid == request.auth.uid;
        allow update, delete: if request.auth != null && get(/databases/$(database)/documents/empresas/$(empresaId)).data.proprietarioUid == request.auth.uid;
      }

      // Bloqueios: only owner may write
      match /bloqueios/{blockId} {
        allow read: if true;
        allow create, update, delete: if request.auth != null && get(/databases/$(database)/documents/empresas/$(empresaId)).data.proprietarioUid == request.auth.uid;
      }

      // Agendamentos: public may create "solicitado" entries; updates/deletes limited
      match /agendamentos/{agId} {
        allow read: if true;

        // Public create allowed but enforce initial status and required fields
        allow create: if (
          request.resource.data.status == 'solicitado'
          && request.resource.data.inicio is string
          && request.resource.data.fim is string
        );

        // Updates allowed for owner (confirm/cancel) or the cliente who created it
        allow update: if request.auth != null && (
          get(/databases/$(database)/documents/empresas/$(empresaId)).data.proprietarioUid == request.auth.uid
          || request.auth.uid == resource.data.clienteUid
        );

        allow delete: if request.auth != null && get(/databases/$(database)/documents/empresas/$(empresaId)).data.proprietarioUid == request.auth.uid;
      }

      // Clientes: creation via Cloud Function only (remove public create); reads/updates/deletes restricted to proprietario only.
      match /clientes/{clienteId} {
        // Only proprietario can read the clients list/details
        allow read: if request.auth != null && get(/databases/$(database)/documents/empresas/$(empresaId)).data.proprietarioUid == request.auth.uid;

        // Disallow public create - only owner or admin SDK should create clients.
        allow create: if false;

        // Only proprietario can modify or delete clients
        allow update, delete: if request.auth != null && get(/databases/$(database)/documents/empresas/$(empresaId)).data.proprietarioUid == request.auth.uid;
      }
    }

    // Usuários: owner only
    match /usuarios/{userId} {
      // Owner can do everything with their own document
      allow read, create, update, delete: if request.auth != null && request.auth.uid == userId;
      
      // Allow authenticated users to query by email (for signup validation)
      // This is needed for verificarEmailExistente() in auth.js
      allow list: if request.auth != null;
    }
  }
}
