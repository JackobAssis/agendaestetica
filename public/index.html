<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AgendaEst√©tica - SaaS de Agenda Online para Profissionais Est√©ticos">
    <meta name="theme-color" content="#6B46C1">
    
    <title>AgendaEst√©tica - Login</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/assets/images/favicon.svg">
    <link rel="apple-touch-icon" href="/assets/images/favicon.svg">
    
    <link rel="stylesheet" href="/styles/global.css">
    <link rel="stylesheet" href="/styles/login.css">
    
<!-- Firebase Configuration - INJETADO VIA BUILD -->
<script>
(function() {
    // Verificar se j√° existe configura√ß√£o
    if (window.APP_CONFIG && window.APP_CONFIG.firebase) {
        console.log('‚úÖ Firebase config j√° carregada');
        return;
    }
    
    // Configura√ß√£o do Firebase - ser√° injetada pelo build
    window.APP_CONFIG = {
        firebase: {
            apiKey: "AIzaSyDj3cSnhFusveRRzCm8OGOIboiqQjCYy94",
            authDomain: "agendaestetica-fe8b9.firebaseapp.com",
            projectId: "agendaestetica-fe8b9",
            storageBucket: "agendaestetica-fe8b9.firebasestorage.app",
            messagingSenderId: "735305856969",
            appId: "1:735305856969:web:9d28f77af9d302f2699a18"
        }
    };
    
    console.log('‚úÖ Firebase config injetada');
})();
</script>
<!-- End Firebase Configuration -->
</head>
<body>
    <div id="app">
        <!-- Loading state -->
        <div class="loading-screen" id="loading-screen">
            <div class="loading-spinner"></div>
            <p>Carregando AgendaEst√©tica...</p>
        </div>
    </div>
    
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js';
        import { getAuth, setPersistence, browserLocalPersistence } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js';
        import { getStorage } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js';
        
        // App imports
        import firebaseConfig from './config.js';
        import { markFirebaseInitialized } from './modules/firebase.js';
        
        // ‚úÖ Verifica√ß√£o RIGOROSA de configura√ß√£o
        function isFirebaseConfigValid(config) {
            if (!config) return false;
            if (typeof config.apiKey !== 'string') return false;
            if (config.apiKey.length <= 10) return false;
            if (config.apiKey.includes('placeholder') || config.apiKey.includes('INJETAR')) return false;
            if (config.apiKey.includes('undefined')) return false;
            if (config.apiKey.includes('null')) return false;
            if (!config.apiKey.startsWith('AIzaSy')) return false;
            return true;
        }
        
        const isValidConfig = isFirebaseConfigValid(firebaseConfig);
        const isProduction = window.location.hostname !== 'localhost' && 
                            window.location.hostname !== '127.0.0.1';
        
        // Fun√ß√£o para exibir tela de erro cr√≠tico
        function showCriticalError() {
            document.getElementById('loading-screen').innerHTML = `
                <div class="error-screen">
                    <h2>‚ö†Ô∏è Erro Cr√≠tico de Configura√ß√£o</h2>
                    <p>Firebase n√£o est√° configurado corretamente.</p>
                    <p class="error-details">O app n√£o pode funcionar sem configura√ß√£o v√°lida.</p>
                    <p><strong>Para resolver:</strong></p>
                    <ul>
                        <li>Configure VITE_FIREBASE_* no Vercel Dashboard</li>
                        <li>Verifique FIREBASE-SETUP.md</li>
                    </ul>
                    <p class="error-details">Error: Firebase configuration missing</p>
                </div>
            `;
        }
        
        // Fun√ß√£o para exibir tela de modo demo
        function showDemoMode() {
            document.getElementById('loading-screen').innerHTML = `
                <div class="demo-mode-screen">
                    <h2>üß™ Modo Desenvolvimento</h2>
                    <p>Firebase n√£o configurado - modo demo.</p>
                    <p>Configure .env.local para testar autentica√ß√£o.</p>
                    <ul>
                        <li>VITE_FIREBASE_API_KEY</li>
                        <li>VITE_FIREBASE_AUTH_DOMAIN</li>
                        <li>VITE_FIREBASE_PROJECT_ID</li>
                        <li>VITE_FIREBASE_STORAGE_BUCKET</li>
                        <li>VITE_FIREBASE_MESSAGING_SENDER_ID</li>
                        <li>VITE_FIREBASE_APP_ID</li>
                    </ul>
                </div>
            `;
        }
        
        // Fun√ß√£o para inicializar Firebase PRIMEIRO
        // Reference: 2.0.md > Tarefa 3 - Inicializa√ß√£o correta do Firebase
        async function initializeFirebaseFirst() {
            try {
                console.log('üîß Inicializando Firebase...');
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                const storage = getStorage(app);
                
                // Persist√™ncia
                setPersistence(auth, browserLocalPersistence)
                    .catch(error => console.warn('Persistence warning:', error.message));
                
                // Expor globalmente ANTES de carregar m√≥dulos
                window.firebaseApp = app;
                window.firebase = { app, auth, db, storage, firestore: db };
                
                // ‚úÖ Marcar Firebase como inicializado
                // Reference: 2.0.md > Tarefa 3 - Evitar m√∫ltiplos initializeApp
                markFirebaseInitialized();
                
                console.log('‚úÖ Firebase inicializado com sucesso');
                return { app, auth, db, storage };
            } catch (error) {
                console.error('‚ùå Firebase init error:', error);
                throw error;
            }
        }
        
        // Fun√ß√£o para carregar router e verificar sess√£o
        async function loadApp() {
            try {
                const { setupRouter } = await import('./router.js');
                const { verificarSessao } = await import('./modules/auth.js');
                
                // Setup router
                await setupRouter();
                
                // Verificar sess√£o
                await verificarSessao();
                
                console.log('‚úÖ App carregado com sucesso');
            } catch (error) {
                console.error('‚ùå App load error:', error);
            }
        }
        
        // ‚úÖ Fluxo principal - inicializa Firebase primeiro
        async function main() {
            if (isValidConfig) {
                // Configura√ß√£o v√°lida - inicializar Firebase primeiro
                console.log('‚úÖ Firebase config v√°lida');
                try {
                    await initializeFirebaseFirst();
                    await loadApp();
                } catch (error) {
                    console.error('‚ùå Erro na inicializa√ß√£o:', error);
                    showCriticalError();
                }
            } else if (isProduction) {
                // Produ√ß√£o sem config v√°lida - erro cr√≠tico
                console.error('‚ùå Firebase config INV√ÅLIDA ou AUSENTE em produ√ß√£o!');
                console.error('API Key:', firebaseConfig?.apiKey || 'N√ÉO DEFINIDA');
                showCriticalError();
                
                // Setup router mesmo assim para permitir navega√ß√£o
                await loadApp();
            } else {
                // Desenvolvimento sem config - modo demo
                console.warn('‚ö†Ô∏è Firebase config n√£o encontrada - modo demo');
                showDemoMode();
                
                // Setup router em modo demo
                await loadApp();
            }
        }
        
        // Iniciar aplica√ß√£o
        main();
    </script>
    
    <style>
        .loading-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: var(--font-family, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-border, #e0e0e0);
            border-top-color: var(--color-primary, #6B46C1);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .demo-mode-screen {
            text-align: center;
            padding: 24px;
            max-width: 500px;
            background: #fff3e0;
            border: 1px solid #ffb74d;
            border-radius: 8px;
        }
        
        .demo-mode-screen h2 { color: #e65100; margin-bottom: 16px; }
        .demo-mode-screen ul { text-align: left; font-size: 13px; color: #666; margin: 16px 0; }
        
        .error-screen {
            text-align: center;
            padding: 24px;
            max-width: 500px;
            background: #ffebee;
            border: 1px solid #ef5350;
            border-radius: 8px;
        }
        
        .error-screen h2 { color: #c62828; margin-bottom: 16px; }
        .error-details { font-size: 12px; color: #666; margin-top: 8px; }
    </style>
</body>
</html>

